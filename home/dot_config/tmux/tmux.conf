# ==============================================================================
# CATPPUCCIN MOCHA PALETTE (@cp-)
# ==============================================================================

set -g @cp-rosewater "#f5e0dc"
set -g @cp-flamingo  "#f2cdcd"
set -g @cp-pink      "#f5c2e7"
set -g @cp-mauve     "#cba6f7"
set -g @cp-red       "#f38ba8"
set -g @cp-peach     "#fab387"
set -g @cp-yellow    "#f9e2af"
set -g @cp-teal      "#94e2d5"
set -g @cp-blue      "#89b4fa"
set -g @cp-lavender  "#b4befe"
set -g @cp-text      "#cdd6f4"
set -g @cp-subtext1  "#bac2de"
set -g @cp-subtext0  "#a6adc8"
set -g @cp-overlay1  "#7f849c"
set -g @cp-overlay0  "#6c7086"
set -g @cp-surface1  "#45475a"
set -g @cp-surface0  "#313244"
set -g @cp-bg        "#1e1e2e"
set -g @cp-crust     "#11111b"

# ==============================================================================
# STYLE HELPERS (@style-*, @bg-*)
# ==============================================================================
# Style fragments for consistent theming

# Foreground styles
set -g @style-text      "fg=#{@cp-text}"
set -g @style-muted     "fg=#{@cp-overlay1}"
set -g @style-inactive  "fg=#{@cp-overlay0}"
set -g @style-accent    "fg=#{@cp-mauve}"
set -g @style-highlight "fg=#{@cp-lavender}"

# Background styles
set -g @bg-overlay      "bg=#{@cp-overlay0}"

# ==============================================================================
# ICONS (@i-)
# ==============================================================================
# Nerd Font glyphs - trailing space for proportional width
# TODO: set icons for common programs

set -g @i-tmux   " " # ebc8  - tmux
set -g @i-prefix " " # f427  - rocket
set -g @i-copy   " " # f4bb  - copy
set -g @i-sync   " " # f46a  - sync
set -g @i-clock  " " # f43a  - clock
set -g @i-tree   " " # f03a  - list (session/window manager)
set -g @i-zoom   " " # f002  - expand/zoom
set -g @i-window "󰓩 " # f04e9 - tab (window)
set -g @i-pane   " " # f489  - terminal (pane title)
set -g @i-uptime " " # f4e3  - hourglass (uptime)

# ==============================================================================
# GENERAL OPTIONS
# ==============================================================================

set  -g mouse             on    # Enable mouse support
set  -g mode-keys         vi    # vi-style key bindings in copy mode
set  -g status-keys       emacs # Emacs key bindings in tmux command prompt
set  -g history-limit     50000
set  -g display-time      4000  # Message display duration (4s)
set  -s escape-time       0     # No delay for escape key (vim/neovim)
set  -g focus-events      on    # Pass focus events to applications
set  -g repeat-time       1000  # Repeatable key bindings timeout (1s)
set  -g allow-passthrough on    # Allow image passthrough
set  -s set-clipboard     on    # Allow apps to set terminal clipboard (OSC 52)
set  -g set-titles        on    # Set outside terminal title

# ==============================================================================
# WINDOW & PANE OPTIONS
# ==============================================================================

set  -g base-index         1   # Start windows at 1, not 0
set  -g pane-base-index    1   # Start panes at 1, not 0
set  -g renumber-windows   on  # Renumber windows when one is closed
set  -g aggressive-resize  on  # Resize to smallest client
set  -g monitor-activity   on  # Monitor for activity in other windows
set  -g visual-activity    off # Suppress activity messages

# ==============================================================================
# APPEARANCE
# ==============================================================================

# Pane borders
set -gF pane-border-style             "#{@style-inactive}"
set -gF pane-active-border-style      "#{@style-highlight}"

# Messages
set -gF message-style                 "fg=#{@cp-teal},#{@bg-overlay}"
set -gF message-command-style         "fg=#{@cp-teal},#{@bg-overlay}"

# Copy mode
set -gF mode-style                    "bg=#{@cp-surface0},bold"
set -gF copy-mode-match-style         "fg=#{@cp-crust},bg=#{@cp-yellow}"
set -gF copy-mode-current-match-style "fg=#{@cp-crust},bg=#{@cp-peach}"

# Clock mode
set -gF clock-mode-colour             "#{@cp-blue}"

# Popup and menu styles
set -gF popup-style                   "bg=#{@cp-bg},#{@style-text}"
set -gF popup-border-style            "fg=#{@cp-surface1}"
set -gF menu-selected-style           "#{@style-text},bold,#{@bg-overlay}"

# ==============================================================================
# STATUS BAR: Config
# ==============================================================================

set -g status-position     top
set -g status-style        "bg=default"
set -g status-justify      absolute-centre
set -g status-interval     5            # Refresh status bar every 5s
set -g status              2            # Two status lines
set -g status-left-length  100
set -g status-right-length 100

# ==============================================================================
# STATUS BAR: Mode Detection (@mode-is-*)
# ==============================================================================

# Decomposed mode detection for debugging
# tmux display -p "#{E:@mode-is-prefix}"

# Mode checks (boolean-ish: 1 or 0/empty)
set -g @mode-is-prefix "#{?client_prefix,1,0}"
set -g @mode-is-tree   "#{==:#{pane_mode},tree-mode}"
set -g @mode-is-clock  "#{==:#{pane_mode},clock-mode}"
set -g @mode-is-copy   "#{pane_in_mode}"

# ==============================================================================
# STATUS BAR: Modules (@m-*)
# ==============================================================================

# Session+mode: icon changes per mode, color applies to both icon and name
set -g @m-session "\
#{?#{E:@mode-is-prefix},#[fg=#{@cp-red}]#{@i-prefix} #S,\
#{?#{E:@mode-is-tree},#[fg=#{@cp-teal}]#{@i-tree} #S,\
#{?#{E:@mode-is-clock},#[fg=#{@cp-mauve}]#{@i-clock} #S,\
#{?#{E:@mode-is-copy},#[fg=#{@cp-blue}]#{@i-copy} #S,\
#[fg=#{@cp-teal}]#{@i-tmux} #S}}}}"

# Sync: peach sync icon when panes are synchronized
set -g @m-sync   "#{?pane_synchronized,#[fg=#{@cp-peach}]#{@i-sync},}"

# Zoom: mauve zoom icon when pane is zoomed
set -g @m-zoom   "#{?window_zoomed_flag,#[fg=#{@cp-mauve}]#{@i-zoom},}"
set -g @m-uptime "#[fg=#{@cp-rosewater}]#{@i-uptime}#[fg=#{@cp-overlay1}] #(tmux-uptime)"

# ==============================================================================
# STATUS & TITLE BAR
# ==============================================================================

set -g status-left       "#{E:@m-session}  #{E:@m-sync}#{E:@m-zoom}"
set -g status-right      "#{E:@m-uptime}"
set -g set-titles-string '#S'

# ==============================================================================
# STATUS BAR: Window List (window-status-*)
# ==============================================================================

# Window activity is indicated with a trailing *
# Inactive windows use overlay0 text
# Current window indicator uses lavender for the full segment
# Activity uses asterisk indicator only, no color override

set -g  window-status-separator      " "
set -gF window-status-style          "fg=#{@cp-overlay0}"
set -g  window-status-format         "[#I] #W#{?window_activity_flag,*,}"
set -gF window-status-current-style  "fg=#{@cp-lavender},bold"
set -gF window-status-last-style     "#{@style-inactive}"
set -g  window-status-current-format "█ [#I] #W"
set -g  window-status-activity-style "none"
set -gF window-status-bell-style     "fg=#{@cp-red}"

# ==============================================================================
# KEYBINDINGS
# ==============================================================================

# Prefix: Ctrl+Space
set    -g prefix C-Space
unbind C-b
bind   C-Space   send-prefix

# Prefix+R - reload config
bind r { source ~/.config/tmux/tmux.conf; display "config reloaded" }

# Prefix+p/n - previous/next window
bind -r p previous-window
bind -r n next-window

# Prefix+P/N - move window left/right
bind -r N { swap-window -t +1; next-window }
bind -r P { swap-window -t -1; previous-window }

# Vim-style copy mode: v=select, C-v=block, y=yank
bind -T copy-mode-vi v   send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y   send -X copy-selection

# Session manager (Prefix+b: session browser; Ctrl-N to create)
bind b display-popup -E "~/.config/tmux/session-manager.sh"
bind g popup -T lazygit -d "#{pane_current_path}" -w 90% -h 90% -E lazygit

# Prefix+a - Agent popup with name prompt (parent:suffix window naming)
# bind a command-prompt -p "agent:" \
  # "run-shell \"tmux display-popup -E -w 90% -h 90% -e 'PARENT=#S' -e 'DIR=#{pane_current_path}' -e 'SUFFIX=%%' ~/.config/tmux/agent-popup.sh\""

# Prefix+A - Switch between agent windows
bind A display-popup -E "tmux choose-tree -wf '#{==:#{session_name},_agent}'"

# Lines below this point break syntax highlighting

# Spacer under status bar
set -gF status-format[1] ""

# Open panes in current directory
bind '"' splitw -c       '#{pane_current_path}'
bind '%' splitw -h -c    '#{pane_current_path}'
